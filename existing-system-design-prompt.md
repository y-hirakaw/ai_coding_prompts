# 既存システム改修向け技術設計書変換プロンプト

## 概要

既存システムへの機能追加・改修の要求仕様書を、開発エンジニアが実装タスクに分解できるレベルの
「技術設計資料」に変換するためのプロンプトです。

認証・認可、DB基盤、CI/CDなど **既存の仕組みをそのまま活用する前提** で、
改修範囲の特定と既存機能への影響分析に重点を置いています。

**入力**:
- 改修の要求仕様書（Googleドキュメント、PDF等）
- 既存システムの情報（コードベース、API仕様書、ER図など。添付または口頭補足）

**出力**: 改修向け技術設計書（Markdown + Mermaid図）

**新規構築の場合は** [spec-to-technical-design-prompt.md](spec-to-technical-design-prompt.md) を使用してください。

## 使い方

1. AIチャットに要求仕様ドキュメントを添付
2. 既存システムの情報があれば併せて添付（既存API仕様書、ER図、アーキテクチャ図など）
3. 以下のプロンプトをコピー＆ペースト
4. 出力をレビューし、対話で修正を繰り返す

### ツールの使い分け

| ツール | メリット | コツ |
|--------|---------|------|
| **Gemini (Advanced以上)** | 推論能力が高く、既存システムの暗黙的な制約を補完する能力に長ける | 既存のER図やAPI仕様書を一緒に添付すると精度が上がる |
| **NotebookLM** | ドキュメントへの忠実度が高く、既存仕様との矛盾を検出しやすい | 既存仕様と改修要件を両方ソースに追加して使う |
| **Claude** | 長文の構造化と差分分析に強い。既存コードの直接分析も可能 | 既存コードを添付して「この上に改修を設計して」と指示 |

---

## プロンプト

以下をコピーしてそのまま使用してください。

```
あなたは、既存システムの改修・機能追加に精通した熟練のソフトウェアアーキテクト兼テックリードです。
ドメイン駆動設計（DDD）と段階的なシステム進化の設計に精通しています。

添付した「改修の要求仕様書」と「既存システムの情報」を読み込み、
既存システムの仕組み（認証、DB基盤、API規約、デプロイフロー等）を最大限に活用しながら、
開発エンジニアが実装タスク（GitHub Issue/PBI）に分解できるレベルの「改修向け技術設計資料」を
作成してください。

## 制約事項

* 出力はMarkdown形式とし、図解が必要な箇所は **Mermaid記法** で記述してください。
* 既存システムの仕組みを変更する必要がある箇所と、そのまま利用する箇所を明確に区別してください。
  - `[既存流用]`: 既存の仕組みをそのまま使用（リスク: なし）
  - `[既存拡張]`: 既存の仕組みに追加・変更が必要（リスク: 中〜高。既存機能への影響確認が必要）
  - `[新規追加]`: 完全に新しく作る部分（リスク: 低〜中）
  - `[推論補完]`: 既存情報が不足しており推論で補完した箇所（リスク: 要検証。レビュー時に重点確認）
* **出力の冒頭にこの変更分類マーカーの凡例を含めてください。**
* 既存のコード規約、命名規則、アーキテクチャパターンに従った設計とすること。
* 既存機能への影響（破壊的変更、パフォーマンス劣化、副作用）を必ず分析すること。
* 既存のトランザクション境界、排他制御パターン、冪等性保証に影響を与える変更を必ず特定すること。
* 未決事項の質問は、非技術者（プロダクトオーナー等）が読んで回答できる平易な日本語で記述してください。
* 既存システムの情報が不足している場合は、「この情報が必要です」と明示してください。

---

## 出力セクション

### 0. 改修の背景と目標

改修の全体像を非技術者にも伝わる形で記述してください。

#### 0.1 改修の背景
* この改修が必要になったビジネス上の理由
* 改修しない場合のビジネスリスク

#### 0.2 達成目標
* この改修で達成すべきビジネス目標 / KPI
* 成功基準（何をもって「改修完了」とするか）

#### 0.3 改修前後のユーザー体験の変化
* 既存ユーザーの操作フローに変更があるか
* UIの変更点（画面レベルで差分を示す）
* 既存ユーザーへの告知・移行支援の要否

---

### 1. 既存システムの前提整理

改修対象の既存システムについて理解した内容を整理してください。
**既存情報が添付されていない場合は、確認が必要な項目としてリストアップしてください。**

#### 1.1 技術スタック
* 使用言語・フレームワーク・主要ライブラリ
* DBエンジンとバージョン
* インフラ構成（クラウドプロバイダー、コンテナ等）

#### 1.2 既存アーキテクチャ
* アーキテクチャパターン（モノリス / マイクロサービス / モジュラーモノリス等）
* レイヤー構成（Controller → Service → Repository等）
* 認証・認可方式: `[既存流用]` （具体的な方式を記載）
* API規約（パス命名、レスポンス形式、エラーハンドリングパターン）

#### 1.3 改修に関わる既存機能の特定
* 改修で直接変更が必要な既存モジュール/クラス/テーブル
* 改修により間接的に影響を受ける可能性のある既存機能
  - 直接依存: コードレベルで呼び出し/参照がある機能
  - 間接依存: データや状態を共有している機能（動作確認が必要）

---

### 2. 改修スコープ定義

改修の全体像を定義してください。

#### 2.1 変更分類マップ

改修に含まれる全変更を、以下の4カテゴリに分類して一覧化してください。

| 変更対象 | 分類 | 変更内容の概要 | 影響範囲 | ビジネスリスク | 優先度 |
|---------|------|--------------|---------|--------------|--------|
| orders テーブル | `[既存拡張]` | カラム追加（discount_amount） | 注文API、注文一覧画面 | Low | Must |
| CouponService | `[新規追加]` | クーポン適用ロジック | - | Low | Must |
| OrderService | `[既存拡張]` | クーポン割引の計算処理追加 | 注文作成フロー | Medium | Must |
| 認証・認可 | `[既存流用]` | 変更なし | - | - | - |

#### 2.2 スコープ外の明示

| スコープ外項目 | 除外理由 | 将来対応の見込み | ビジネスへの影響 |
|--------------|---------|----------------|---------------|
| [項目] | [理由] | Phase 2 / 未定 / 不要 | [影響の有無と内容] |

#### 2.3 MVPスコープ

全変更を以下の3段階に分類してください:
* **Must（MVP必須）**: この改修の目的達成に不可欠な変更
* **Should（推奨）**: あることが望ましいが、最悪なくてもリリース可能
* **Could（次フェーズ候補）**: スケジュールリスク時に先送り可能

---

### 3. ユビキタス言語（用語定義）

改修で **新たに追加される用語** のみ定義してください。
既存用語は「既存の〇〇を参照」と記載し、重複定義を避けること。

* 形式: `日本語名 (EnglishName): 定義`
* 既存用語と衝突する場合は、既存定義との関係を注記

---

### 4. データモデル変更（差分設計）

既存のデータモデルに対する **変更差分のみ** を定義してください。
既存テーブルの全カラムを再定義する必要はありません。

#### 4.1 テーブル変更一覧

| テーブル名 | 変更種別 | 変更内容 | マイグレーション方針 |
|-----------|---------|---------|-------------------|
| orders | カラム追加 | discount_amount (DECIMAL, nullable, default: 0) | ALTER TABLE ADD COLUMN（ゼロダウンタイム可） |
| coupons | 新規テーブル | クーポンマスタ | CREATE TABLE |
| order_coupons | 新規テーブル | 注文-クーポン紐付け | CREATE TABLE |

#### 4.2 新規/変更テーブルのER図
* Mermaidの `erDiagram` で **変更部分のみ** を図示
* 既存テーブルとのリレーションも含めること
* 新規カラム/テーブルが分かるように注記

#### 4.3 マイグレーション詳細
* 各マイグレーションのゼロダウンタイム実行可否
* 既存データへの影響（既存レコードのデフォルト値、NOT NULL制約の段階追加等）
* ロールバック手順
* 既存インデックスへの影響と新規インデックスの追加
* **データ整合性検証**: マイグレーション前後のデータ件数照合、外部キー制約の整合性チェック方法

---

### 5. 業務フロー変更（差分設計）

既存フローに対する **変更差分** を可視化してください。

* Mermaidの `sequenceDiagram` または `stateDiagram` を使用
* **既存ステップ** と **追加/変更ステップ** を視覚的に区別すること
  （例: 追加ステップにはノート `[新規追加]` を付与）
* 以下を網羅:
  - 正常系への変更
  - 新たに発生する異常系
  - 既存の異常系で振る舞いが変わるケース

---

### 6. API変更（差分設計）

既存APIへの変更と新規APIを区分して定義してください。

#### 6.1 既存API変更

| エンドポイント | 変更種別 | 変更内容 | 後方互換性 | 移行戦略 |
|--------------|---------|---------|-----------|---------|
| POST /api/v1/orders | リクエスト拡張 | coupon_code追加（optional） | 完全互換 | 対策不要 |
| GET /api/v1/orders/{id} | レスポンス拡張 | discount_amountフィールド追加 | 完全互換 | 対策不要 |

**後方互換性の3段階評価**:
* **完全互換**: 既存クライアントに影響なし。対策不要
* **条件付き互換**: optional追加等。クライアント更新を推奨するが必須ではない
* **非互換**: APIバージョニング必須。旧API廃止スケジュール要定義

各変更APIについて:
* 変更されるリクエスト/レスポンスの **差分のみ** を記載
* 新規バリデーションルール
* 後方互換性の評価（既存クライアントが壊れないか）

#### 6.2 新規API

新規追加するエンドポイントは、既存APIの規約に従って定義してください。
* 認証・認可: `[既存流用]`（既存と同じ方式を適用）
  - ただし、新規APIに必要な認可粒度が既存モデルで不足する場合は明記すること
* エラーレスポンス: 既存のエラーフォーマットに準拠
* 既存のAPI命名規則・バージョニング規約に従うこと
* CORSポリシー: 既存ポリシーで対応可能か、変更が必要か

---

### 7. トランザクション・整合性の変更（差分設計）

改修により既存のトランザクション設計に影響を与える変更を特定してください。

#### 7.1 既存トランザクション境界への影響
* 改修により変更されるトランザクションスコープの特定
* トランザクション時間の延長が発生する箇所とリスク評価
* 新規テーブル/外部呼び出しの追加によるトランザクション範囲の拡大

#### 7.2 排他制御の変更
* 既存のロック戦略（楽観的/悲観的）との整合性
* 新規テーブル/カラムに対するロック方針
* デッドロックリスクの評価

#### 7.3 冪等性の担保
* 新規APIの冪等性設計（既存方式に準拠）
* 既存の冪等性保証に影響を与える変更の有無
* 改修で追加される外部呼び出しのリトライ安全性評価

---

### 8. 既存コード変更箇所の特定

改修で変更が必要な既存のクラス/モジュール/ファイルを特定してください。

| 変更対象 | ファイルパス（推定） | 変更メソッド/関数 | 変更内容 | 既存テスト影響 | 変更の複雑度 | 前提リファクタリング |
|---------|-------------------|----------------|---------|--------------|------------|-------------------|
| OrderService | app/services/order_service.* | calculateTotal() | クーポン割引ロジック追加 | order_service_test修正必要 | 中 | なし |
| OrderController | app/controllers/orders_controller.* | create() | パラメータ追加 | controller_test修正必要 | 低 | なし |

* 変更の複雑度: 高（ロジック大幅変更）/ 中（メソッド追加・条件分岐追加）/ 低（パラメータ追加等）
* 前提リファクタリング: 変更対象の既存コードが複雑な場合、改修前にリファクタリングが必要か
* 推奨する実装順序（DB先行 → API後追い等）の提示

---

### 9. 影響分析

改修による既存機能への影響を分析してください。**これが最も重要なセクションです。**

#### 9.1 直接的な影響

| 影響を受ける機能 | 影響内容 | 重大度 | 対策 |
|----------------|---------|--------|------|
| 注文一覧API | レスポンスにフィールド追加 | Low | 後方互換性あり、対策不要 |
| 売上レポート | 割引額の考慮が必要 | High | レポートロジックの修正が必要 |

#### 9.2 間接的な影響（波及リスク）
* パフォーマンスへの影響（新しいJOIN、追加クエリ等）
* 既存のバッチ処理への影響
* 既存の通知・メール送信への影響
* キャッシュへの影響（キャッシュ無効化が必要な箇所）
* 外部連携（Webhook、外部API連携等）への影響
* イベント/メッセージングシステムへの影響（イベントスキーマの変更、新規イベント追加）
* セキュリティへの影響（既存のアクセス制御ルール、データ分類の変更、信頼境界の変化）

#### 9.3 既存テストへの影響
* 壊れる可能性のある既存テストの特定（テストファイル名と理由）
* 修正が必要な既存テストの一覧
* 既存テストスイートのカバレッジで不足する改修影響範囲の特定
* 既存のE2Eテストシナリオで更新が必要なもの

#### 9.4 改修リスクサマリー

影響分析の結果をまとめ、ステークホルダーが一目でリスクを把握できるようにしてください。

| リスク項目 | 発生確率 | 影響度 | 総合リスク | 緩和策 |
|-----------|---------|--------|-----------|--------|
| [例: 既存APIの後方互換性] | Low | High | Medium | [対策] |
| [例: パフォーマンス劣化] | Medium | Medium | Medium | [対策] |

**総合リスク評価**: High / Medium / Low
**PO/ステークホルダーへの推奨事項**: [一文で要約]

---

### 10. 非機能要件（改修固有の観点）

既存システムの非機能要件は基本的に踏襲する前提で、
**改修によって新たに考慮が必要になる非機能要件のみ** を記載してください。

#### 10.1 パフォーマンス影響
* 新しいクエリ/JOINによるレスポンスタイム影響の見積もり
  - 本番相当データ量でのクエリ実行計画（EXPLAIN ANALYZE相当）の分析指針
  - 既存APIのベースラインレイテンシに対する予想劣化幅
* データ量増加の見込み（新規テーブルの行数推定、既存テーブルへの容量増）
* 既存SLOへの影響分析
  - 改修による予想レイテンシ変化がSLOのエラーバジェットに与える影響
  - SLO違反リスクがある場合の緩和策
* パフォーマンス検証計画（負荷テストの実施要否と計画）

#### 10.2 セキュリティ影響分析（改修固有）

##### 10.2.1 アタックサーフェスの変化
* 新規APIエンドポイントの追加による攻撃面の拡大
* 新規データ入力経路と信頼境界の変化
* 既存の脅威モデルへの影響

##### 10.2.2 データ分類と保護要件
* 新たに扱うデータの分類（Public / Internal / Confidential / Restricted）
* 分類に基づく暗号化要件（保存時・通信時）
* 個人情報の特定と保護要件（既存の暗号化基盤で対応可能か）

##### 10.2.3 認証・認可の整合性検証
* 新規APIエンドポイントに必要な認可ルール（リソースオーナーシップ、ロール等）
* 既存の権限モデルとのギャップ分析（不足する認可粒度の特定）
* 認可バイパスリスクの評価（IDOR、権限昇格等）

##### 10.2.4 入力バリデーション・サニタイゼーション
* 新規入力パラメータのバリデーションルール一覧
* 既存のバリデーションフレームワークでの対応可否
* インジェクション対策（SQL、XSS、SSRF等）

##### 10.2.5 セキュリティテストカバレッジ
* 既存のSAST/SCA/DASTで新規コードもカバーされるか
* 追加が必要なセキュリティテストケース

#### 10.3 可観測性（追加分）
* **ログ出力要件**
  - 新規機能のログ出力ポイント（既存のログフォーマットに準拠）
  - 改修によるログ量の増加見込み
* **セキュリティ監査ログ**
  - 新規操作で記録すべきイベント（データアクセス、変更操作等）
  - 記録項目: Who / What / When / Where / Result
  - 既存の監査ログ基盤で新機能をカバーできるか
* **メトリクス追加**
  - 新規APIのREDメトリクス（Rate, Error rate, Duration）
  - 改修対象の既存APIへの計測ポイント追加
  - 新規テーブルに関するDBメトリクス
* **アラート追加**
  - 新規アラート条件と閾値
  - 既存アラート閾値の見直し要否（改修によりSLOアラートが発火しやすくなる可能性）
* 既存の監視ダッシュボードへの追加項目

#### 10.4 データプライバシー（該当する場合）
* 新たに収集・保存するデータに個人情報が含まれるか
* 既存のデータ保持/パージポリシーの適用範囲に追加が必要か

#### 10.5 依存ライブラリの変更
* 新規追加が必要なライブラリとその理由
* 既存ライブラリのバージョンアップが必要な場合の影響
* ライセンス互換性の確認

---

### 11. テスト戦略（改修固有）

#### 11.1 新規テスト
* **ユニットテスト**: 新規/変更したビジネスロジックのテスト対象
  - 境界値テスト（新規フィールドの最大値/最小値/NULL）
  - 既存データとの整合性（マイグレーション前データでの動作確認）
* **統合テスト**: 新規API、既存APIの変更部分
  - 後方互換性の検証（既存リクエスト形式での動作確認）
* **E2Eテスト**: 改修で影響を受けるユーザーシナリオ
* **非機能テスト**: 改修によるパフォーマンス影響の検証（セクション10.1との連動）
* **セキュリティテスト**: 新規APIエンドポイント/入力値に対するセキュリティ検証

#### 11.2 回帰テスト（最重要）
* **既存テストスイートの現状評価**
  - 影響範囲に関連する既存テストのカバレッジ状況
  - 既存テストの最終実行結果と信頼性
* **回帰テスト範囲の優先度分類**（セクション9との連動）
  - P1（必須）: 直接影響（9.1）で重大度Medium以上の機能 → 全パスの回帰テスト
  - P2（推奨）: 間接影響（9.2）で特定された機能 → 主要パスのスモークテスト
  - P3（任意）: 関連する周辺機能 → サンプリングテスト
* 既存テストの修正が必要な箇所
* 手動テストが必要な箇所（自動テストでカバーできない部分）
* 後方互換性テスト: 既存クライアントが改修後も正しく動作することの検証方法

#### 11.3 テスト環境・テストデータ
* **テストデータ要件**
  - マイグレーション前の既存データパターン（正常系/エッジケース/不整合データ）
  - 改修機能のテストに必要な新規テストデータ
  - パフォーマンステスト用のデータ量見積もり
  - 本番データを使用する場合の匿名化/マスキング方針
* **テスト環境**
  - 既存テスト環境への変更が必要か（新規テーブルのマイグレーション等）
  - Feature Flag有効/無効の両パターンでのテスト環境
  - 外部サービスのモック追加が必要か

#### 11.4 品質ゲート・リリース判定基準
* **回帰テスト合格基準**: 既存テスト全パス（100%）
* **新規テストカバレッジ**: 変更コードに対するカバレッジ目標
* **パフォーマンス基準**: セクション10.1で定義したSLOの維持確認
* **セキュリティスキャン**: SAST/SCA/DASTのクリア（新規コード含む）
* **リリース判定のGo/No-Go基準**: 上記を満たさない場合のエスカレーション先

---

### 12. マイグレーション・リリース計画

#### 12.1 マイグレーション手順
* DBマイグレーションの実行順序と各ステップのリスク
* ゼロダウンタイムで実行可能か
  - Expand-Contractパターンを使う場合の共存期間の設計
  - 共存期間中のデータ同期方針
* ロールバック設計（各ステップごと）
  - ロールバック発動の判断基準（どのメトリクスがどの閾値を超えたら発動するか）
  - ロールバック所要時間の見積もり
  - ロールバック後のデータ整合性確認手順
  - ロールバック不可能なステップの特定と代替策
* データ整合性検証: マイグレーション前後のデータ件数照合、外部キー制約の整合性チェック方法

#### 12.2 リリース戦略
* 既存のデプロイフロー `[既存流用]` に従うか、追加手順が必要か
  - マイグレーション実行とコードデプロイの実行順序・タイミング
  - CI/CDパイプラインへの変更要否
* Feature Flagの使用要否
  - 使用する場合: フラグの粒度、デフォルト値、削除計画（期日設定）
  - フラグ状態の監視方法
* 段階的リリースの必要性（カナリア、%ロールアウト等）
  - ロールアウトの段階設計（例: 1% → 5% → 25% → 100%）
  - 各段階の最低観察時間と成功/失敗の判定メトリクス

#### 12.3 リリース前チェックリスト
* DBマイグレーション完了確認
* 既存機能の動作確認項目（スモークテスト）
* ロールバック手順の事前テスト
* 監視ダッシュボードでの異常有無確認ポイント

#### 12.4 リリース後監視計画
* 監視強化期間と体制（リリース後24h/72h/1weekの段階）
* 監視強化対象のメトリクスと一時的な閾値
  - 改修対象APIのレイテンシ（p50/p95/p99）のベースライン比較
  - エラーレートの変化
* 通常監視に戻す判断基準
* 改修起因の障害が疑われる場合の切り分け手順
  （改修範囲と障害症状の対応表）

#### 12.5 運用影響
* 運用負荷の変化
  - 新規バッチ処理/定期ジョブの追加有無と監視要件
  - 新規アラートによるオンコール負荷の見積もり
* コスト影響
  - DBストレージ/バックアップ容量の増加見込み
  - コンピュートリソース（CPU/メモリ）への影響
* 下流サービスへの通知計画
  - APIレスポンス変更に伴う下流チーム/サービスへの事前通知

#### 12.6 承認チェックポイント

| マイルストーン | 承認者 | 承認内容 | 判断材料 |
|--------------|--------|---------|---------|
| 設計レビュー完了 | テックリード / PO | スコープと影響範囲の合意 | 本設計書 |
| 回帰テスト完了 | QA / PO | 既存機能への影響なし確認 | テストレポート |
| リリース判断 | PO / ステークホルダー | 本番リリースのGo/No-Go | テスト結果、監視体制 |

---

### 13. 実装上の懸念点・未決事項

エンジニアが実装するにあたり、情報が不足している点や技術的リスクを整理してください。

**質問は非技術者が回答できる平易な表現で記述すること。**

| カテゴリ | 懸念点 | 影響度 | 推奨アクション |
|----------|--------|--------|---------------|
| 既存仕様の不明点 | [具体的な不明点] | High/Medium/Low | [平易な質問と確認先] |
| 後方互換性 | [具体的なリスク] | High/Medium/Low | [対策案] |
| パフォーマンス | [具体的な懸念] | High/Medium/Low | [対策案] |
| 改修範囲の曖昧さ | [スコープの不明確な部分] | High/Medium/Low | [確認事項] |

---

### 14. アーキテクチャ判断記録（ADR）

改修で判断が必要になった技術的選択について記録してください。
**既存の仕組みを変更する判断は特に詳しく記録すること。**

| 項目 | 内容 |
|------|------|
| **判断事項** | [何を決めたか] |
| **背景** | [なぜその判断が必要だったか] |
| **既存の仕組み** | [現状どうなっているか] |
| **選択肢** | [既存流用 / 既存拡張 / 新規構築 のそれぞれのPros/Cons] |
| **決定** | [何を選んだか] |
| **理由** | [なぜそれを選んだか（既存変更のリスクを含む）] |
| **影響** | [この判断による既存システムへの影響] |
```

---

## オプション: マルチパースペクティブ評価

上記で生成された改修向け技術設計書を、以下の5つの視点でセルフレビューしてください。

```
上記の改修向け技術設計書を、以下の5つの専門家の視点でレビューし、
各視点ごとに Good（良い点）/ Concern（懸念点）/ Missing（不足）を指摘してください。

1. **シニアバックエンドエンジニア**: 既存コードへの影響分析の精度、データモデル変更の安全性、後方互換性、トランザクション・排他制御・冪等性
2. **QAエンジニア**: 回帰テスト範囲の十分性、既存テストへの影響、テストデータ要件、品質ゲートの妥当性、エッジケースの網羅性
3. **プロダクトマネージャー**: 改修スコープの明確さ、ビジネス要求との整合性、スコープ外事項の妥当性、ユーザー体験への影響
4. **セキュリティエンジニア**: アタックサーフェスの変化、既存認可モデルとの整合性、データ分類の正確さ、暗号化要件の充足性、監査ログのカバレッジ
5. **DevOps/SREエンジニア**: マイグレーションの安全性、ロールバック計画の現実性、リリース後監視計画、パフォーマンス影響の評価、運用負荷の見積もり
```

---

## 次のステップ

この改修向け技術設計書をレビュー・確定した後、[technical-design-to-pbi-prompt.md](technical-design-to-pbi-prompt.md) を使用して
PBI（Product Backlog Item）/ GitHub Issue に分割できます。
